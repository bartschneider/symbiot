# Development Dockerfile for Next.js Application
# Optimized for ARM64 with hot reloading

FROM node:20-alpine AS development

WORKDIR /app

# Install system dependencies including OpenSSL for Prisma
RUN apk add --no-cache \
    git \
    curl \
    bash \
    openssl

# Copy package files
COPY package*.json ./
COPY tsconfig*.json ./
COPY next.config.ts ./

# Install dependencies
RUN npm ci

# Copy source code (will be overridden by volume mounts in development)
COPY src/ ./src/
COPY public/ ./public/
COPY prisma/ ./prisma/

# Generate Prisma client with correct binary targets
RUN npx prisma generate

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001 -G nodejs && \
    chown -R nextjs:nodejs /app

USER nextjs

# Expose port for Next.js dev server
EXPOSE 5173

# Set development environment variables
ENV NODE_ENV=development
ENV NEXT_PUBLIC_API_BASE_URL=http://localhost:3001
ENV PORT=5173
ENV HOSTNAME=0.0.0.0

# Start development server
CMD ["npm", "run", "dev:container"]